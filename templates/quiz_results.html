{% extends 'base.html' %}
{% load static %}

{% block page_title %}Quiz Results{% endblock %}
{% block page_subtitle %}Review your performance{% endblock %}

{% block content %}
<div class="h-[calc(100vh-12rem)] min-h-[600px] flex justify-center items-center py-6">
    <div class="glass-panel w-full max-w-2xl rounded-3xl p-8 md:p-12 text-center relative overflow-hidden">
        <!-- Confetti / decoration background -->
        <div class="absolute inset-0 pointer-events-none overflow-hidden">
            <div class="absolute top-0 left-1/4 w-2 h-2 bg-primary rounded-full animate-ping opacity-50"></div>
            <div class="absolute top-10 right-1/4 w-3 h-3 bg-indigo-500 rounded-full animate-ping opacity-30 delay-300">
            </div>
        </div>

        <div class="mb-2 relative flex flex-col items-center justify-center">
            <div
                class="w-48 h-48 rounded-full border-[10px] border-white/5 flex items-center justify-center relative bg-[#0f172a]/50 backdrop-blur-sm">
                <svg class="absolute inset-0 w-full h-full -rotate-90 text-primary drop-shadow-[0_0_15px_rgba(95,114,236,0.5)] transform scale-[0.85] origin-center"
                    viewBox="0 0 100 100">
                    <circle cx="50" cy="50" r="46" fill="transparent" stroke-width="8" stroke="currentColor"
                        stroke-dasharray="290" stroke-dashoffset="0" id="score-circle-bg" class="text-white/5">
                    </circle>
                    <circle cx="50" cy="50" r="46" fill="transparent" stroke-width="8" stroke="currentColor"
                        stroke-dasharray="290" stroke-dashoffset="290" stroke-linecap="round" id="score-circle"
                        class="transition-all duration-1000 ease-out"></circle>
                </svg>
                <div class="flex flex-col items-center z-10">
                    <span class="text-5xl font-bold text-white mb-1" id="score-text">0/0</span>
                    <span class="text-xs text-slate-400 uppercase tracking-wider font-medium">Score</span>
                </div>
            </div>
            <!-- Badge moved below circle with negative margin for clean overlap -->
            <div class="-mt-5 z-20 px-6 py-2 rounded-full bg-emerald-500/20 border border-emerald-500/30 text-emerald-400 text-sm font-bold shadow-xl backdrop-blur-md"
                id="score-badge">
                Splendid!
            </div>
        </div>

        <div class="mt-8 space-y-2">
            <h2 class="text-3xl font-bold text-white mb-2" id="feedback-title">Great Job!</h2>
            <p class="text-slate-400 mb-8 max-w-md mx-auto leading-relaxed" id="feedback-msg">You have a good grasp of
                the material.
                Keep practicing to perfect your skills.</p>
        </div>

        <div class="grid grid-cols-2 gap-4 mb-8">
            <div
                class="glass-panel p-4 rounded-xl flex flex-col items-center justify-center bg-white/5 hover:bg-white/10 transition-colors">
                <span class="material-icons-round text-primary mb-2 text-2xl">timer</span>
                <span class="text-2xl font-bold text-white" id="time-text">00:00</span>
                <span class="text-xs text-slate-500 uppercase tracking-wider mt-1">Time Taken</span>
            </div>
            <div
                class="glass-panel p-4 rounded-xl flex flex-col items-center justify-center bg-white/5 hover:bg-white/10 transition-colors">
                <span class="material-icons-round text-amber-400 mb-2 text-2xl">stars</span>
                <span class="text-2xl font-bold text-white" id="xp-text">+0</span>
                <span class="text-xs text-slate-500 uppercase tracking-wider mt-1">XP Earned</span>
            </div>
        </div>

        <div class="flex flex-col sm:flex-row gap-4 justify-center">
            <a href="{% url 'quiz' upload.id %}"
                class="px-8 py-3.5 rounded-xl border border-white/10 hover:bg-white/5 text-white font-medium transition-colors flex items-center justify-center gap-2 group">
                <span
                    class="material-icons-round group-hover:-rotate-180 transition-transform duration-500">replay</span>
                Try Again
            </a>
            <a href="{% url 'dashboard' %}"
                class="px-8 py-3.5 rounded-xl bg-gradient-to-r from-primary to-indigo-600 text-white font-bold shadow-lg shadow-primary/25 hover:shadow-primary/40 hover:-translate-y-0.5 transition-all flex items-center justify-center gap-2 group">
                Back to Dashboard
                <span class="material-icons-round group-hover:translate-x-1 transition-transform">arrow_forward</span>
            </a>
        </div>
    </div>
</div>
</div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    // Get params from URL
    const urlParams = new URLSearchParams(window.location.search);
    const score = parseInt(urlParams.get('score')) || 0;
    const total = parseInt(urlParams.get('total')) || 5;
    const timeTaken = urlParams.get('time') || "00:00";

    // Calculate XP (e.g., 10 XP per point)
    const xp = score * 10;

    // Update DOM
    document.getElementById('score-text').textContent = `${score}/${total}`;
    document.getElementById('time-text').textContent = timeTaken;
    document.getElementById('xp-text').textContent = `+${xp}`;

    const percentage = (score / total) * 100;
    const circle = document.getElementById('score-circle');
    // SVG is 100x100, r=46. Circumference = 2 * PI * 46 ~= 289.02
    const circumference = 290;
    const offset = circumference - (percentage / 100) * circumference;

    // Animate circle
    setTimeout(() => {
        circle.style.strokeDashoffset = offset;
    }, 300);

    // Update Text
    const title = document.getElementById('feedback-title');
    const msg = document.getElementById('feedback-msg');
    const badge = document.getElementById('score-badge');

    if (percentage >= 80) {
        title.textContent = "Excellent!";
        msg.textContent = "You've mastered this topic! Ready for the next challenge?";
        badge.textContent = "Master";
        badge.className = "-mt-5 z-20 px-6 py-2 rounded-full bg-emerald-500/20 border border-emerald-500/30 text-emerald-400 text-sm font-bold shadow-xl backdrop-blur-md";
        circle.classList.add('text-emerald-500');
    } else if (percentage >= 50) {
        title.textContent = "Good Effort!";
        msg.textContent = "You're getting there. A little more review and you'll ace it.";
        badge.textContent = "Proficient";
        badge.className = "-mt-5 z-20 px-6 py-2 rounded-full bg-amber-500/20 border border-amber-500/30 text-amber-400 text-sm font-bold shadow-xl backdrop-blur-md";
        circle.classList.add('text-amber-500');
    } else {
        title.textContent = "Keep Practicing";
        msg.textContent = "Don't give up! Review the study materials and try again.";
        badge.textContent = "Novice";
        badge.className = "-mt-5 z-20 px-6 py-2 rounded-full bg-rose-500/20 border border-rose-500/30 text-rose-400 text-sm font-bold shadow-xl backdrop-blur-md";
        circle.classList.add('text-rose-500');
    }

</script>
{% endblock %}