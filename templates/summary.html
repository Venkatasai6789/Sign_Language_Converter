{% extends 'base.html' %}
{% load static %}

{% block page_title %}Summary & Learn{% endblock %}
{% block page_subtitle %}{{ upload.title }}{% endblock %}

{% block content %}
<div class="h-[calc(100vh-8rem)] min-h-[600px] flex gap-6 pb-6">
    <!-- Left Panel: Summary & Concepts -->
    <div class="w-1/2 flex flex-col gap-6 h-full overflow-y-auto pr-2 custom-scrollbar">
        <!-- Header -->
        <div class="flex items-center justify-between">
            <div
                class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-white/5 border border-white/10 text-xs font-medium text-slate-300">
                <span class="material-icons-round text-sm text-primary">school</span>
                Learning Module
            </div>
            <span class="text-xs text-slate-500 font-medium tracking-wider uppercase">~5 min read</span>
        </div>

        <!-- AI Executive Summary -->
        <div class="glass-panel p-6 rounded-2xl relative overflow-hidden group border border-white/10"
            style="background: rgba(15, 23, 42, 0.6); backdrop-filter: blur(12px);">
            <div
                class="absolute -right-10 -top-10 w-32 h-32 bg-primary/10 rounded-full blur-3xl transition-all duration-500 group-hover:bg-primary/20">
            </div>
            <h2 class="text-lg font-bold text-white mb-4 flex items-center gap-2">
                <span class="material-icons-round text-amber-400">auto_awesome</span>
                AI Executive Summary
            </h2>
            <div class="prose prose-invert prose-sm max-w-none text-white leading-relaxed max-h-60 overflow-y-auto custom-scrollbar pr-2"
                id="summary-content">
                {{ summary_data.summary|linebreaks }}
            </div>
        </div>

        <!-- Key Concepts -->
        {% if summary_data.key_concepts %}
        <div class="space-y-4">
            <h3 class="text-sm font-bold text-slate-500 uppercase tracking-wider px-2">Key Concepts</h3>
            {% for concept in summary_data.key_concepts %}
            <div
                class="glass-panel p-5 rounded-xl border-l-4 {% if concept.color == 'green' %}border-emerald-500{% elif concept.color == 'blue' %}border-blue-500{% else %}border-purple-500{% endif %} bg-white/5 hover:bg-white/10 transition-colors">
                <h4 class="text-white font-bold mb-1">{{ concept.title }}</h4>
                <p class="text-sm text-slate-400">{{ concept.description }}</p>
            </div>
            {% endfor %}
        </div>
        {% endif %}

        <!-- Important Terms -->
        {% if summary_data.important_terms %}
        <div class="space-y-3">
            <h3 class="text-sm font-bold text-slate-500 uppercase tracking-wider px-2">Key Vocabulary</h3>
            <div class="flex flex-wrap gap-2">
                {% for term in summary_data.important_terms %}
                <span
                    class="px-3 py-1.5 rounded-lg bg-white/5 border border-white/10 text-sm text-slate-300 hover:text-white hover:border-white/30 transition-colors cursor-pointer">
                    {{ term }}
                </span>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <!-- Original Text (Collapsible) -->
        <div class="border-t border-white/10 pt-4">
            <details class="group">
                <summary
                    class="list-none flex items-center justify-between cursor-pointer text-slate-500 hover:text-white transition-colors">
                    <span class="text-sm font-medium">View Original Extracted Text</span>
                    <span class="material-icons-round transition-transform group-open:rotate-180">expand_more</span>
                </summary>
                <div
                    class="mt-4 p-4 rounded-xl bg-black/20 text-xs text-slate-400 font-mono leading-relaxed whitespace-pre-wrap h-64 overflow-y-auto">
                    {{ upload.extracted_text }}
                </div>
            </details>
        </div>
    </div>

    <!-- Right Panel: Video Player -->
    <div class="w-1/2 flex flex-col gap-4 h-full">
        <div
            class="glass-panel p-1 rounded-2xl flex-1 flex flex-col relative overflow-hidden bg-black/40 backdrop-blur-xl border border-white/10">
            <!-- Video Container -->
            <div
                class="flex-1 relative rounded-xl overflow-hidden bg-gradient-to-br from-gray-900 to-black flex items-center justify-center">
                <!-- Avatar Placeholder / Video -->
                <div class="absolute inset-0 flex items-center justify-center">
                    <video id="sign-video" class="w-full h-full object-contain" autoplay playsinline muted>
                        <source src="" type="video/mp4">
                        Your browser does not support the video tag.
                    </video>
                    <!-- Avatar Silhouette (Visible when no video or loading) -->
                    <div id="avatar-placeholder" class="hidden absolute inset-0 flex items-center justify-center">
                        <div class="w-48 h-64 bg-slate-800/50 rounded-full blur-xl"></div>
                        <span class="material-icons-round text-6xl text-slate-700">person</span>
                    </div>
                </div>

                <!-- Overlay Controls -->
                <div class="absolute bottom-6 left-0 right-0 px-8 flex flex-col gap-4">
                    <!-- Current Word -->
                    <div class="text-center">
                        <span id="current-word-display"
                            class="inline-block px-6 py-2 rounded-xl bg-black/60 backdrop-blur-md text-2xl font-bold text-white tracking-wide shadow-lg border border-white/10 transform transition-all duration-300 scale-100">
                            Loading...
                        </span>
                    </div>

                    <!-- Progress Bar -->
                    <div class="w-full h-1.5 bg-white/20 rounded-full cursor-pointer overflow-hidden relative"
                        id="progress-container">
                        <div id="progress-bar"
                            class="absolute top-0 left-0 h-full bg-primary transition-all duration-300 w-0"></div>
                    </div>

                    <!-- Controls -->
                    <div class="flex items-center justify-between text-white">
                        <div class="flex items-center gap-4">
                            <button onclick="togglePlay()" class="p-2 rounded-full hover:bg-white/10 transition-colors">
                                <span class="material-icons-round text-3xl" id="play-icon">pause</span>
                            </button>
                            <button onclick="skip(-1)" class="p-2 rounded-full hover:bg-white/10 transition-colors">
                                <span class="material-icons-round">skip_previous</span>
                            </button>
                            <button onclick="skip(1)" class="p-2 rounded-full hover:bg-white/10 transition-colors">
                                <span class="material-icons-round">skip_next</span>
                            </button>
                            <button onclick="speakCurrentWord()"
                                class="p-2 rounded-full hover:bg-white/10 transition-colors" title="Read Aloud">
                                <span class="material-icons-round text-xl">volume_up</span>
                            </button>
                        </div>

                        <div class="flex items-center gap-2">
                            <span class="text-xs text-slate-400 font-mono" id="progress-text">0/0</span>
                            <button id="speed-btn" onclick="toggleSpeed()"
                                class="p-2 rounded-lg hover:bg-white/10 transition-colors text-xs font-bold text-slate-400">1.0x</button>
                            <button onclick="toggleFullscreen()"
                                class="p-2 rounded-lg hover:bg-white/10 transition-colors">
                                <span class="material-icons-round text-xl">fullscreen</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Actions Footer -->
            <div class="h-16 border-t border-white/5 bg-white/5 flex items-center justify-between px-6">
                <div class="flex gap-2">
                    <button onclick="openDictionary()"
                        class="p-2 rounded-lg hover:bg-white/10 transition-colors flex items-center gap-2 text-sm text-slate-300">
                        <span class="material-icons-round text-lg">book</span> Dictionary
                    </button>
                    <!-- <button class="p-2 rounded-lg hover:bg-white/10 transition-colors flex items-center gap-2 text-sm text-slate-300">
                        <span class="material-icons-round text-lg">sticky_note_2</span> Notes
                    </button> -->
                </div>
                <a href="{% url 'quiz' upload.id %}"
                    class="px-5 py-2 rounded-lg bg-primary hover:bg-primary-dark text-white text-sm font-bold shadow-lg shadow-primary/25 transition-all flex items-center gap-2">
                    Take Quiz <span class="material-icons-round text-base">arrow_forward</span>
                </a>
            </div>
        </div>
    </div>
</div>

<style>
    .active-sign-word {
        background: rgba(95, 114, 236, 0.2);
        color: #fff;
        border-radius: 4px;
        box-shadow: 0 0 10px rgba(95, 114, 236, 0.3);
        transition: all 0.3s ease;
        padding: 0 2px;
    }

    /* Custom Scrollbar */
    .custom-scrollbar::-webkit-scrollbar {
        width: 6px;
    }

    .custom-scrollbar::-webkit-scrollbar-track {
        background: rgba(255, 255, 255, 0.05);
        border-radius: 10px;
    }

    .custom-scrollbar::-webkit-scrollbar-thumb {
        background: rgba(255, 255, 255, 0.2);
        border-radius: 10px;
    }

    .custom-scrollbar::-webkit-scrollbar-thumb:hover {
        background: rgba(255, 255, 255, 0.3);
    }
</style>

<!-- Dictionary Modal -->
<div id="dictionary-modal"
    class="fixed inset-0 z-50 flex items-center justify-center hidden opacity-0 transition-opacity duration-300">
    <!-- Backdrop -->
    <div class="absolute inset-0 bg-black/80 backdrop-blur-sm" onclick="closeDictionary()"></div>

    <!-- Modal Card -->
    <div class="relative w-full max-w-md mx-4 glass-panel rounded-2xl overflow-hidden transform scale-95 transition-transform duration-300 shadow-2xl border border-white/10 opacity-0 transition-opacity"
        id="dictionary-card">
        <!-- Decoration -->
        <div
            class="absolute top-0 right-0 w-64 h-64 bg-primary/20 rounded-full blur-3xl -translate-y-1/2 translate-x-1/2 pointer-events-none">
        </div>
        <div
            class="absolute bottom-0 left-0 w-48 h-48 bg-purple-500/20 rounded-full blur-3xl translate-y-1/2 -translate-x-1/2 pointer-events-none">
        </div>

        <!-- Header -->
        <div class="relative p-6 border-b border-white/10 flex items-center justify-between">
            <h2 class="text-xl font-bold text-white flex items-center gap-2">
                <span class="material-icons-round text-primary">menu_book</span>
                Sign Dictionary
            </h2>
            <button onclick="closeDictionary()"
                class="p-2 rounded-full hover:bg-white/10 transition-colors text-slate-400 hover:text-white">
                <span class="material-icons-round">close</span>
            </button>
        </div>

        <!-- Search -->
        <div class="p-6 pb-2">
            <div class="relative">
                <span class="material-icons-round absolute left-3 top-1/2 -translate-y-1/2 text-slate-400">search</span>
                <input type="text" placeholder="Search for a sign..."
                    class="w-full bg-black/40 border border-white/10 rounded-xl py-3 pl-10 pr-4 text-white placeholder-slate-500 focus:outline-none focus:border-primary/50 focus:ring-1 focus:ring-primary/50 transition-all">
            </div>
        </div>

        <!-- List -->
        <div class="p-6 pt-2 h-96 overflow-y-auto custom-scrollbar">
            <div class="space-y-3">
                <!-- Static Sample Data until backend is ready -->
                <div
                    class="p-4 rounded-xl bg-white/5 hover:bg-white/10 transition-colors border border-white/5 group cursor-pointer">
                    <div class="flex justify-between items-start mb-1">
                        <h3 class="text-white font-bold text-lg group-hover:text-primary transition-colors">Hello</h3>
                        <span
                            class="text-xs px-2 py-0.5 rounded bg-purple-500/20 text-purple-300 border border-purple-500/30">Greeting</span>
                    </div>
                    <p class="text-sm text-slate-400 leading-relaxed">A common greeting performed by touching the
                        forehead with the palm and moving the hand outward in a small arc.</p>
                </div>

                <div
                    class="p-4 rounded-xl bg-white/5 hover:bg-white/10 transition-colors border border-white/5 group cursor-pointer">
                    <div class="flex justify-between items-start mb-1">
                        <h3 class="text-white font-bold text-lg group-hover:text-primary transition-colors">Friend</h3>
                        <span
                            class="text-xs px-2 py-0.5 rounded bg-emerald-500/20 text-emerald-300 border border-emerald-500/30">Noun</span>
                    </div>
                    <p class="text-sm text-slate-400 leading-relaxed">Interlocking both index fingers twice, alternating
                        which finger is on top, symbolizing a strong bond or connection.</p>
                </div>

                <div
                    class="p-4 rounded-xl bg-white/5 hover:bg-white/10 transition-colors border border-white/5 group cursor-pointer">
                    <div class="flex justify-between items-start mb-1">
                        <h3 class="text-white font-bold text-lg group-hover:text-primary transition-colors">Thank You
                        </h3>
                        <span
                            class="text-xs px-2 py-0.5 rounded bg-amber-500/20 text-amber-300 border border-amber-500/30">Phrase</span>
                    </div>
                    <p class="text-sm text-slate-400 leading-relaxed">The hand moves from the mouth outward toward the
                        person being thanked, with fingers together/flat.</p>
                </div>

                <div
                    class="p-4 rounded-xl bg-white/5 hover:bg-white/10 transition-colors border border-white/5 group cursor-pointer">
                    <div class="flex justify-between items-start mb-1">
                        <h3 class="text-white font-bold text-lg group-hover:text-primary transition-colors">Understand
                        </h3>
                        <span
                            class="text-xs px-2 py-0.5 rounded bg-pink-500/20 text-pink-300 border border-pink-500/30">Verb</span>
                    </div>
                    <p class="text-sm text-slate-400 leading-relaxed">Flick the index finger up near the forehead,
                        similar to a light bulb turning on, indicating comprehension.</p>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    function openDictionary() {
        const modal = document.getElementById('dictionary-modal');
        const card = document.getElementById('dictionary-card');
        modal.classList.remove('hidden');
        // Small delay to allow display:block to apply before opacity transition
        setTimeout(() => {
            modal.classList.remove('opacity-0');
            card.classList.remove('opacity-0');
            card.classList.remove('scale-95');
            card.classList.add('scale-100');
        }, 10);
    }

    function closeDictionary() {
        const modal = document.getElementById('dictionary-modal');
        const card = document.getElementById('dictionary-card');
        modal.classList.add('opacity-0');
        card.classList.add('opacity-0');
        card.classList.remove('scale-100');
        card.classList.add('scale-95');
        setTimeout(() => {
            modal.classList.add('hidden');
        }, 300);
    }
</script>
{% endblock %}

{% block extra_js %}
{{ words|json_script:"words-data" }}
<script>
    var videoWords = JSON.parse(document.getElementById('words-data').textContent);
    const summaryContainer = document.getElementById('summary-content');
    const videoData = [];

    // Construct video paths (assuming assets are in static/assets/)
    // In a real app, you might want to check if file exists or map to specific URLs
    videoWords.forEach(word => {
        // Ensure consistent capitalization for file matching (files are typically Title Case or Uppercase)
        // Adjust this logic if your filenames vary (e.g., 'A.mp4', 'Apple.mp4')
        videoData.push({
            word: word,
            url: `{% static '' %}${word}.mp4`
        });
    });

    let currentIndex = 0;
    const video = document.getElementById('sign-video');
    const display = document.getElementById('current-word-display');
    const playIcon = document.getElementById('play-icon');
    const progressBar = document.getElementById('progress-bar');
    const progressText = document.getElementById('progress-text');
    let isPlaying = true;

    // --- 1. Prepare Text Highlighting ---
    function prepareSummaryText() {
        // Wrap every word in a span for individual highlighting
        if (!summaryContainer) return;

        const originalText = summaryContainer.innerText;
        // Simple tokenizer splitting by space
        const wrappedText = originalText.split(/([\s\n]+)/).map(part => {
            if (part.trim().length > 0) {
                return `<span>${part}</span>`;
            }
            return part; // Return whitespace as is
        }).join('');
        summaryContainer.innerHTML = wrappedText;
    }

    // Call immediately
    prepareSummaryText();
    const textSpans = summaryContainer ? summaryContainer.querySelectorAll('span') : [];

    // --- 2. Video Player Logic ---

    function updateUI(index) {
        if (index >= videoData.length) return;

        const word = videoData[index].word;
        display.textContent = word;
        display.classList.remove('scale-100');
        display.classList.add('scale-110'); // Pulse effect
        setTimeout(() => {
            display.classList.remove('scale-110');
            display.classList.add('scale-100');
        }, 150);

        progressText.textContent = `${index + 1}/${videoData.length}`;
        const progress = ((index + 1) / videoData.length) * 100;
        progressBar.style.width = `${progress}%`;

        // Highlight Text
        if (textSpans.length > 0) {
            highlightWordInText(word);
        }
    }

    // TTS Logic
    function speakCurrentWord() {
        if (currentIndex < videoData.length) {
            const word = videoData[currentIndex].word;
            window.speechSynthesis.cancel(); // Stop previous
            const utterance = new SpeechSynthesisUtterance(word);
            utterance.rate = 1.0;
            window.speechSynthesis.speak(utterance);
        }
    }

    let lastFoundSpanIndex = 0;

    function highlightWordInText(wordToFind) {
        // Skip highlighting for single letters (fingerspelling) to prevent erratic jumping
        // Exception for 'a' and 'i' which are valid words
        if (wordToFind.length === 1 && !['a', 'i', 'A', 'I'].includes(wordToFind)) {
            return;
        }

        // Clear previous active words ONLY if we are finding a new valid word
        document.querySelectorAll('.active-sign-word').forEach(el => el.classList.remove('active-sign-word'));

        const cleanWordToFind = wordToFind.toLowerCase().replace(/[^a-z0-9]/g, '');
        if (!cleanWordToFind) return;

        // Search from last found index to end
        let found = false;

        if (lastFoundSpanIndex < textSpans.length) {
            for (let i = lastFoundSpanIndex; i < textSpans.length; i++) {
                const spanText = textSpans[i].textContent.toLowerCase().replace(/[^a-z0-9]/g, '');
                if (spanText === cleanWordToFind) {
                    textSpans[i].classList.add('active-sign-word');
                    textSpans[i].scrollIntoView({ behavior: 'smooth', block: 'center' });
                    lastFoundSpanIndex = i + 1; // Update cursor
                    found = true;
                    break;
                }
            }
        }

        // Search from beginning if not found
        if (!found) {
            for (let i = 0; i < lastFoundSpanIndex; i++) {
                const spanText = textSpans[i].textContent.toLowerCase().replace(/[^a-z0-9]/g, '');
                if (spanText === cleanWordToFind) {
                    textSpans[i].classList.add('active-sign-word');
                    textSpans[i].scrollIntoView({ behavior: 'smooth', block: 'center' });
                    lastFoundSpanIndex = i + 1;
                    break;
                }
            }
        }
    }

    // Playback Speed Logic
    const speeds = [1.0, 1.5, 2.0, 0.5];
    let speedIndex = 0;

    function toggleSpeed() {
        speedIndex = (speedIndex + 1) % speeds.length;
        const newSpeed = speeds[speedIndex];
        video.playbackRate = newSpeed;
        document.getElementById('speed-btn').textContent = newSpeed + 'x';
    }

    function playVideo(index) {
        if (index >= videoData.length) {
            isPlaying = false;
            playIcon.textContent = "replay";
            return;
        }

        const data = videoData[index];
        video.src = data.url;

        // Error handling for missing video
        video.onerror = function () {
            console.log(`Video not found for: ${data.word}`);
            // Skip to next after short delay or spell it?
            // For now, just skip matching delay
            setTimeout(() => {
                playNext();
            }, 1000);
        };

        updateUI(index);

        if (isPlaying) {
            video.play().catch(e => console.log("Autoplay blocked", e));
        }
    }

    function playNext() {
        currentIndex++;
        if (currentIndex < videoData.length) {
            playVideo(currentIndex);
        } else {
            // End of playlist
            isPlaying = false;
            playIcon.textContent = "replay";
        }
    }

    function togglePlay() {
        if (currentIndex >= videoData.length) {
            // Replay
            currentIndex = 0;
            isPlaying = true;
            playVideo(0);
            playIcon.textContent = "pause";
            return;
        }

        if (video.paused) {
            video.play();
            isPlaying = true;
            playIcon.textContent = "pause";
        } else {
            video.pause();
            isPlaying = false;
            playIcon.textContent = "play_arrow";
        }
    }

    function skip(direction) {
        const newIndex = currentIndex + direction;
        if (newIndex >= 0 && newIndex < videoData.length) {
            currentIndex = newIndex;
            playVideo(currentIndex);
        }
    }

    function toggleFullscreen() {
        const videoContainer = document.querySelector('.relative.rounded-xl.overflow-hidden.bg-gradient-to-br');
        if (!document.fullscreenElement) {
            if (videoContainer.requestFullscreen) {
                videoContainer.requestFullscreen();
            } else if (videoContainer.webkitRequestFullscreen) { /* Safari */
                videoContainer.webkitRequestFullscreen();
            } else if (videoContainer.msRequestFullscreen) { /* IE11 */
                videoContainer.msRequestFullscreen();
            }
        } else {
            if (document.exitFullscreen) {
                document.exitFullscreen();
            } else if (document.webkitExitFullscreen) { /* Safari */
                document.webkitExitFullscreen();
            } else if (document.msExitFullscreen) { /* IE11 */
                document.msExitFullscreen();
            }
        }
    }

    video.onended = function () {
        playNext();
    };

    // Initialize
    if (videoData.length > 0) {
        playVideo(0);
    } else {
        display.textContent = "No sign data available";
    }

</script>
{% endblock %}